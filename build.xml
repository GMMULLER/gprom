<project 
	name="GProMJDBC" 
	default="jar" 
	basedir="."
	xmlns:ivy="antlib:org.apache.ivy.ant"
	xmlns:artifact="antlib:org.apache.maven.artifact.ant"
	xmlns:if="ant:if"
    xmlns:unless="ant:unless"
	>
	
	<description>
		GProM is a provenance middleware for databases.
	</description>
	
	<!-- do not add ant classpath to javac classpath -->
<!--	<presetdef name="javac">
		<javac includeantruntime="false" />
	</presetdef> -->
	
	<!-- Main Class and Packages-->
  	<property name="mainclass" value="org.gprom.jdbc.test.SQLiteJDBCTest" />
	<property name="jar.creator" value="Illinois Institute of Technology, Department of Computer Science, DBGroup" />
	<property name="package" value="*" />
	<property name="mvn.description" value="GProM is a provenance database middleware." />
	<property name="mvn.url" value="https://github.com/IITDBGroup/gprom" />
	
	<!-- define artifacts' name, which follows the convention of Maven -->
	<property name="artifactId" value="gprom-jdbc" />
	
	<!-- ClassPath Setup -->
	<property name="classpath.name.bin" value="classpath.bin" />
	<property name="classpath.name.build" value="classpath.build" />
	<property name="classpath.name.test" value="classpath.test" />
	
	<!-- main directories -->
	<property name="dir.source" value="${basedir}/src/interfaces/jdbc/java" />
	<property name="dir.bin" value="${basedir}/javabin" />
	<property name="dir.testsource" value="${basedir}/javatest" />
	<property name="dir.build" value="${basedir}/jdbcbuild" />
	<property name="dir.library" value="${basedir}/javalib" />
	<property name="dir.testlib" value="${basedir}/javatestlib" />
	<property name="dir.buildresource" value="${basedir}/ant" />
	
	<property name="jar.bin" value="${dir.build}/gprom-jdbc.jar" />
	<property name="jar.bin.fat" value="${dir.build}/gprom-jdbc-all.jar" />

	<!-- Import macro definitions and common stuff -->
	<import file="antutils/ant-common.xml" />
	
	<!-- special files -->
	<property name="conffile" value="${dir.library}/GProMDriver.properties" />
	<property name="log4jconffile" value="${dir.library}/log4j.properties" />
	<property name="ivyfile.test" value="${dir.buildresource}/ivy-test.xml" />
	
	<!-- GProM c-library -->
	<property name="gpromlib.darwin.src" value="${basedir}/src/libgprom/.libs/libgprom.dylib" />
	<property name="gpromlib.darwin.bin" value="${dir.bin}/darwin/libgprom.dylib" />
	<property name="gpromlib.darwin" value="${dir.build}/libgprom.jnilib" />	
	
	<property name="gpromlib.linux.src" value="${basedir}/src/libgprom/.libs/libgprom.so.0" />
	<property name="gpromlib.linux.bin" value="${dir.bin}/unix/libgprom.so.0" />
	<property name="gpromlib.linux" value="${dir.build}/libgprom.so" />
	
	<property name="antlibdir" value="${basedir}/ant" />
	<!--	<import file="${antlibdir}/one-jar-ant-task.xml"/>-->   
		
	
	<!-- TARGETS -->	
	<!-- download dependencies with ivy -->
	<target name="download-dependencies" 
			depends="mkdirs-and-setup-props" 
			description="use ivy to download dependencies">
		
		<ivy-download-deps
			ivyfile="${ivyfile.test}"
			libsdir="${dir.testlib}"
			buildivyfile=""
			/>
		<ivy-download-deps/>
		<classpath-from-dir dir="${dir.buildlib}" 
				pathname="${classpath.name.build}" 
				pathnamejar="${classpath.name.build}.jar"/>
		<classpath-from-dir dir="${dir.library}" 
				pathname="${classpath.name.bin}" 
				pathnamejar="${classpath.name.bin}.jar"/>
		<classpath-from-dir dir="${dir.testlib}" 
				pathname="${classpath.name.test}" 
				pathnamejar="${classpath.name.test}.jar"/>
	</target>
	
	<!--		<target name="download-dependencies-old" >
	 <ivy:settings file="${basedir}/ivysettings.xml"/>
		 <ivy:resolve />
		 <ivy:retrieve sync="false" type="jar" pattern="${dir.library}/[artifact].[ext]" />
		
	     <move todir="${antlibdir}">
			<fileset dir="${dir.library}">
		      <include name="ant*.jar"/>
		    </fileset>
		</move>
		
	     <move todir="${dir.testlib}">
			<fileset dir="${dir.library}">
		      <include name="xerces*.jar"/>
		      <include name="xml*.jar"/>
		      <include name="slf4j*.jar"/>
			  <include name="junit.jar" />
		    </fileset>
		</move>
		<copy todir="${dir.testlib}">
			<fileset dir="${dir.library}">
				<include name="log4j-api.jar"/>
				<include name="log4j-core.jar"/>
				<include name="postgresql.jar"/>
				<include name="mysql-connector-java.jar"/>
				<include name="junit.jar"/>
				<include name="jna.jar"/>
				<include name="stringtemplate.jar"/>
			</fileset>
		</copy>
	
		<path id="classpath">
			<fileset dir="${dir.library}"/>
		</path>
		<path id="testclasspath">
			<fileset dir="${dir.testlib}"/>
		</path>
		<pathconvert property="jarClasspath" pathsep="    ">
			<path>
				<fileset dir="${dir.library}">
					<exclude name="ant*.jar" />
					<exclude name="ivy.jar" />
				</fileset>
			</path>
			<mapper>
				<chainedmapper>
					<flattenmapper/>
					<globmapper from="*.jar" to="lib/*.jar" casesensitive="no"/>
				</chainedmapper>
			</mapper>
		</pathconvert>
		<property name="fullJarClasspath" value="${jarClasspath}   resource/    lib/" />
		<echo message="${fullJarClasspath}" />
	</target>
-->
	<target name="setup-additional-anttasks" 
			depends="download-dependencies">
		<taskdef resource="net/sf/antcontrib/antcontrib.properties"
			classpathref="${classpath.name.build}">
		</taskdef>
	</target>
	
	<!-- check OS type -->
	<target name="handle-os" 
			depends="setup-additional-anttasks">
		<detect-os />
		<if>
	        <equals arg1="${os.type}" arg2="mac" />
	        <then>
	            <echo message="Mac system" />
		        	<property name="gpromlib.src" value="${gpromlib.darwin.src}" />
		        	<property name="gpromlib.bin" value="${gpromlib.darwin.bin}" />
		        	<property name="gpromlib" value="${gpromlib.darwin}" />
	        </then>
		</if>
		<if>
	        <equals arg1="${os.type}" arg2="unix" />
	        <then>
	            <echo message="Linux system" />
		        	<property name="gpromlib.src" value="${gpromlib.linux.src}" />
		        	<property name="gpromlib.bin" value="${gpromlib.linux.bin}" />
		        	<property name="gpromlib" value="${gpromlib.linux}" />
	        </then>
		</if>
    </target>
	
	<!-- build targets -->
	<target name="clean" 
			depends="handle-os"
			description="clean up">
		
		<mkdir dir="${dir.bin}/darwin" />
		<mkdir dir="${dir.bin}/unix" />
		<depend srcdir="${dir.source}"
		        destdir="${dir.bin}"
		        cache="depcache"
		        closure="yes"/>
	</target>
	
	<target name="clean-all"
		description="clean all">
		
		<delete dir="${dir.bin}" includeemptydirs="true" />
		<delete dir="${dir.build}" includeemptydirs="true" />
	</target>

	<target name="compile" 
		depends="clean"
		description="compile JDBC Java files">
		
		<copy file="${gpromlib.src}" tofile="${gpromlib}" overwrite="true" />
		<copy todir="${dir.build}/lib">
			<fileset dir="${dir.library}" />
		</copy>
		<copy file="${gpromlib}" tofile="${gpromlib.bin}" />
		<copy file="${conffile}" tofile="${dir.bin}/GPRoMDriver.properties" />
		<javac srcdir="${dir.source}" 
				destdir="${dir.bin}"  
				debug="on" 
			    fork="true" 
			    includeantruntime="false"
				verbose="true">
			<classpath refid="classpath"/>
			<compilerarg value="-Xlint:unchecked" />		
		</javac>
	</target>
	
	<target name="compile.tests" 
			depends="compile"
			description="compile automated GProM tests Java files">
		
		<javac srcdir="${dir.testsource}" destdir="${dir.bin}" debug="on" fork="true" includeantruntime="false" verbose="true">
			<classpath refid="${classpath.name.test}"/>
			<compilerarg value="-Xlint:unchecked" />
		</javac>
	</target>
	
	<!-- generate a simple jar file for the jdbc driver that does not include referrenced jars and the GProM C-library -->
	<target name="jar" 
			depends="compile"
			description="create Jar file">
		
		<echo message="${classpath.bin.jar}" />
		<create-jar 
			classpath="${classpath.bin.jar} resource/ lib/"/>
	</target>
	
	<!-- generate one combine "fat" jar file that contains all java libraries and native libaries (the GProM application) --> 
	<target name="jar-fat" 
			depends="compile"
			description="generate a fat jar containing all deps">
		
		<create-onejar 
			adddirs="${conffile},${log4jconffile}" 
			binlib="${gpromlib}"/>
<!--        <delete file="${gpromJar.selfContained}"/>
        <one-jar destfile="${gpromJar.selfContained}">
            <manifest>
				<attribute name="Created-By" value="Illinois Institute of Technology, Department for Computer Science, DBGroup" />
    	        		<attribute name="One-Jar-Main-Class" value="org.gprom.jdbc.test.GProMJDBCTest" />
            		<attribute name="Class-Path" value="${fullJarClasspath}" />
            </manifest>
            <main>
                <fileset dir="${dir.bin}/"/>
            </main>
            <lib>
                <fileset file="${dir.library}/*.jar" />
            </lib>
        	<binlib>
        		<fileset file="${gpromlib}" />
        	</binlib>
        	<fileset file="${conffile}" />
        	<fileset file="${log4jconffile}" />
        </one-jar> --> 
	</target>
</project>